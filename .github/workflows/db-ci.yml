name: DB CI

on:
  push:
  pull_request:

jobs:
  migrate-and-seed:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        db: [sqlite3, mysql2]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Configure DB env
        if: matrix.db == 'mysql2'
        run: |
          cat > server/.env << 'EOF'
          MYSQL_HOST=127.0.0.1
          MYSQL_PORT=3306
          MYSQL_USER=root
          MYSQL_PASSWORD=example
          MYSQL_DATABASE=ci_assignment
          DB_CLIENT=mysql2
          EOF

      - name: Configure DB env (sqlite)
        if: matrix.db == 'sqlite3'
        run: |
          cat > server/.env << 'EOF'
          DB_CLIENT=sqlite3
          DATABASE_FILE=./server/dev.sqlite3
          EOF

      - name: Start MySQL service
        if: matrix.db == 'mysql2'
        uses: mysql-actions/mysql-service@v1
        with:
          mysql version: '8.0'
          mysql root password: 'example'

      - name: Create DB
        run: npm run db:create

      - name: Run migrations
        run: npm run db:migrate

      - name: Run seeds
        run: npm run db:seed

      - name: Quick DB smoke test
        run: node ./scripts/test_mysql_insert.js
        env:
          NODE_ENV: test

      - name: List students table
        run: |
          node -e "(async ()=>{ const serverDb=require('./server/db'); await serverDb.migrate(); const db = serverDb.getDb(); const rows = await db('students').select('*').limit(3); console.log('students sample:', rows); process.exit(0) })()"
